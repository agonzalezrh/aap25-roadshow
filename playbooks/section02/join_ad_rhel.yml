---
- 
  name: Configure RHEL to join AD
  hosts: webservers
  gather_facts: true

  vars_files:
    - windows_auth
  vars:
    domain:

  tasks:

   - name: Resolve DNS server hostname to IP
     set_fact:
      domain_controller: windows."{{ domain }}"

  
   - name: Resolve DNS server hostname to IP
     set_fact:
      dns_server_ip: "{{ lookup('dig', domain_controller) }}"

      #### RHEL Tasks 

   - name: Add DNS from AD to /etc/resolv
     lineinfile:
       path: /etc/resolv.conf
       regexp: '^# Generated by NetworkManager'
       line: |
         source {{ wins_domain }}
         nameserver {{ dns_server_ip }}
       insertafter: '^# Generated by NetworkManager'

   - name: Bind to AD with realm
     block:
       - name: Join system
         ansible.builtin.command: /bin/bash -c "echo {{ admin_password }} | realm join --user={{ admin_username }} {{ domain }}"
         register: join_output
         no_log: True
         ignore_errors: yes

       - name: Display success message
         ansible.builtin.debug:
          msg: "Join successful!"
         when: join_output.rc == 0

       - name: Display error message
         ansible.builtin.debug:
          msg: "Join failed or already joined"
         when: join_output.rc != 0
   
