---
- 
  name: Configure RHEL to join AD
  hosts: webservers
  gather_facts: true

  vars_files:
    - windows_auth
  vars:
    wins_domain: "{{ ansible_interfaces[0].dns_domain }}"
    domain_controller: 
    dns_ip:

  tasks:
  
   - name: Store Domain controller IP
     set_fact:
      ad_hostname: windows.{{ ansible_interfaces[0].dns_domain }}

   - name: Remove trailing dot
     set_fact:
      hostname_cleaned: "{{ ad_hostname | regex_replace('\\.$', '') }}"
  
   - name: Resolve DNS server hostname to IP
     set_fact:
      dns_server_ip: "{{ lookup('dig', ad_hostname) }}"

      #### RHEL Tasks 

   - name: Add DNS from AD to /etc/resolv
      lineinfile:
        path: /etc/resolv.conf
        regexp: '^# Generated by NetworkManager'
        line: |
          source {{ wins_domain }}
          nameserver {{ dns_server_ip }}
        insertafter: '^# Generated by NetworkManager'

     - name: Bind to AD with realm
       block:
         - name: Join system
           ansible.builtin.command: /bin/bash -c "echo {{ admin_password }} | realm join --user={{ admin_username }} {{ wins_domain }}"
           register: join_output
           no_log: True
           ignore_errors: yes

         - name: Display success message
           ansible.builtin.debug:
            msg: "Join successful!"
           when: join_output.rc == 0

         - name: Display error message
           ansible.builtin.debug:
            msg: "Join failed or already joined"
           when: join_output.rc != 0
   
